---
- name: Deploy magento
  hosts: local
  connection: local
  gather_facts: False
  vars_files:
    - vars.yml
  tasks:

    - name: Provision server
      rax:
        credentials: "{{ pyrax_creds_file }}"
        region: "{{ region }}"
        name: blueprint
        auto_increment: no
        flavor: "{{ server_flavor }}"
        image: "{{ server_image }}"
        key_name: "{{ server_keypair }}"
        wait: yes
        state: present
        group: blueprint
      register: rax_blueprint

    - name: Add server to host
      add_host:
        hostname: "{{ item.name }}"
        ansible_ssh_host: "{{ item.rax_accessipv4 }}"
        groupname: blueprint
      with_items: rax_blueprint.success
      when: rax_blueprint.action == 'create'

    - name: Provision DB instance
      rax_cdb:
        credentials: "{{ pyrax_creds_file }}"
        name: "{{ db_instance_name }}"
        flavor: "{{ db_flavor }}"
        volume: "{{ db_volume }}"
        state: present
        wait: yes
        region: "{{ region }}"
      register: cdb
      tags: database

    - name: Create DB
      rax_cdb_database:
        credentials: "{{ pyrax_creds_file }}"
        region: "{{ region }}"
        cdb_id: "{{ cdb.cdb.id }}"
        name: "{{ db_name }}"
      register: wp_db
      tags: database

    - name: Create DB user
      rax_cdb_user:
        credentials: "{{ pyrax_creds_file }}"
        region: "{{ region }}"
        cdb_id: "{{ cdb.cdb.id }}"
        db_username: "{{ db_user }}"
        db_password: "{{ db_password }}"
        databases: ["{{ db_name }}"]
      tags: database

    - name: Generate random Magento key
      shell: /usr/bin/openssl rand -base64 32
      register: key_result

- name: Setup server
  hosts: blueprint
  remote_user: root
  vars_files:
    - vars.yml
  roles:
    - { role: nginx, server_hostname: "{{ hostvars.localhost.rax_blueprint.instances[0].rax_accessipv4 }}" }
    - { role: php-fpm }
    - { role: magento, magento_key: "{{ hostvars.localhost.key_result.stdout_lines }}", db_host: "{{ hostvars.localhost.cdb.cdb.hostname }}" }
